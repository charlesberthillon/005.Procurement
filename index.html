<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>005.procurement by charlesberthillon</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>005.procurement</h1>
        <p>Procurement</p>

        <p class="view"><a href="https://github.com/charlesberthillon/005.Procurement">View the Project on GitHub <small>charlesberthillon/005.Procurement</small></a></p>


        <ul>
          <li><a href="https://github.com/charlesberthillon/005.Procurement/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/charlesberthillon/005.Procurement/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/charlesberthillon/005.Procurement">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <div class="highlight highlight-r"><pre><span class="pl-smi">opts_chunk</span><span class="pl-k">$</span>set(<span class="pl-v">results</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>asis<span class="pl-pds">'</span></span>, <span class="pl-v">comment</span> <span class="pl-k">=</span> <span class="pl-c1">NA</span>, <span class="pl-v">message</span> <span class="pl-k">=</span> <span class="pl-c1">F</span>, <span class="pl-v">tidy</span> <span class="pl-k">=</span> <span class="pl-c1">F</span>)
require(<span class="pl-smi">rCharts</span>)
options(<span class="pl-v">RCHART_WIDTH</span> <span class="pl-k">=</span> <span class="pl-c1">600</span>, <span class="pl-v">RCHART_HEIGHT</span> <span class="pl-k">=</span> <span class="pl-c1">400</span>)
read_chunk(<span class="pl-s"><span class="pl-pds">'</span>app/ui.R<span class="pl-pds">'</span></span>); read_chunk(<span class="pl-s"><span class="pl-pds">'</span>app/server.R<span class="pl-pds">'</span></span>); read_chunk(<span class="pl-s"><span class="pl-pds">'</span>app/global.R<span class="pl-pds">'</span></span>)</pre></div>

<h1>
<a id="replicating-ny-times-interactive-graphic" class="anchor" href="#replicating-ny-times-interactive-graphic" aria-hidden="true"><span class="octicon octicon-link"></span></a>Replicating NY Times Interactive Graphic</h1>

<p>This tutorial explains in detail, how I used <code>rCharts</code> to replicate this NY times <a href="http://www.nytimes.com/interactive/2013/03/29/sports/baseball/Strikeouts-Are-Still-Soaring.html?ref=baseball">interactive graphic</a> on strikeouts in baseball. The end result can be seen <a href="http://glimmer.rstudio.com/ramnathv/strikeouts">here</a> as a <code>shiny</code> application.</p>

<h3>
<a id="data" class="anchor" href="#data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data</h3>

<p>The first step is to get data on strikeouts by team across years. The NY Times graphic uses data scraped from <a href="http://www.baseball-reference.com/">baseball-reference</a>, using the <code>XML</code> package in R. However, I will be using data from the R package <a href="http://cran.r-project.org/web/packages/Lahman/index.html">Lahman</a>, which provides tables from <a href="http://www.seanlahman.com/baseball-archive/statistics/">Sean Lahman's Baseball Database</a> as a set of data frames.</p>

<p>The data processing step involves using the <a href="http://cran.r-project.org/web/packages/plyr/index.html">plyr</a> package to create two data frames:</p>

<ol>
<li>
<code>team_data</code> containing <code>SOG</code> (strikeouts per game) by <code>yearID</code> and team <code>name</code>
</li>
<li>
<code>league_data</code> containing <code>SOG</code> by <code>yearID</code> averaged across the league.</li>
</ol>

<div class="highlight highlight-r"><pre>require(<span class="pl-smi">Lahman</span>)  
require(<span class="pl-smi">plyr</span>)
<span class="pl-v">dat</span> <span class="pl-k">=</span> <span class="pl-smi">Teams</span>[,c(<span class="pl-s"><span class="pl-pds">'</span>yearID<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>G<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>SO<span class="pl-pds">'</span></span>)]
<span class="pl-v">team_data</span> <span class="pl-k">=</span> na.omit(transform(<span class="pl-smi">dat</span>, <span class="pl-v">SOG</span> <span class="pl-k">=</span> round(<span class="pl-smi">SO</span><span class="pl-k">/</span><span class="pl-smi">G</span>, <span class="pl-c1">2</span>)))
<span class="pl-v">league_data</span> <span class="pl-k">=</span> ddply(<span class="pl-smi">team_data</span>, .(<span class="pl-smi">yearID</span>), <span class="pl-smi">summarize</span>, <span class="pl-v">SOG</span> <span class="pl-k">=</span> mean(<span class="pl-smi">SOG</span>))</pre></div>

<h3>
<a id="charts" class="anchor" href="#charts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Charts</h3>

<p>We will start by first creating a scatterplot of <code>SOG</code> by <code>yearID</code> across all teams. We use the <code>rPlot</code> function which uses the PolyChartsJS library to create interactive visualizations. The formula interface specifies the x and y variables, the data to use and the type of plot. We  also specify a <code>size</code> and <code>color</code> argument to style the points. Finally, we pass a <code>tooltip</code> argument, which is a javascript function that overrides the default tooltip to display the information we require. You will see below the R code and the resulting chart.</p>

<div class="highlight highlight-r"><pre>require(<span class="pl-smi">rCharts</span>)
<span class="pl-smi">p1</span> <span class="pl-k">&lt;-</span> rPlot(<span class="pl-smi">SOG</span> <span class="pl-k">~</span> <span class="pl-smi">yearID</span>, <span class="pl-v">data</span> <span class="pl-k">=</span> <span class="pl-smi">team_data</span>, <span class="pl-v">type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>point<span class="pl-pds">'</span></span>, 
  <span class="pl-v">size</span> <span class="pl-k">=</span> <span class="pl-k">list</span>(<span class="pl-v">const</span> <span class="pl-k">=</span> <span class="pl-c1">2</span>), <span class="pl-v">color</span> <span class="pl-k">=</span> <span class="pl-k">list</span>(<span class="pl-v">const</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>#888<span class="pl-pds">'</span></span>), 
  <span class="pl-v">tooltip</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>function(item){return item.SOG +'<span class="pl-cce">\n</span>' + item.name + '<span class="pl-cce">\n</span>' + item.yearID}<span class="pl-pds">"</span></span>
)
<span class="pl-smi">p1</span><span class="pl-k">$</span>print(<span class="pl-s"><span class="pl-pds">'</span>chart1<span class="pl-pds">'</span></span>)</pre></div>

<p>Now, we need to add a line plot of the  average <code>SOG</code> for the league by <code>yearID</code>. We do this by adding a second layer to the chart, which copies the elements of the previous layer and overrides the <code>data</code>, <code>type</code>, <code>color</code> and <code>tooltip</code> arguments. The R code is shown below and you will note that the resulting chart now shows a blue line chart corresponding to the league average <code>SOG</code>.</p>

<div class="highlight highlight-r"><pre><span class="pl-smi">p1</span><span class="pl-k">$</span>layer(<span class="pl-v">data</span> <span class="pl-k">=</span> <span class="pl-smi">league_data</span>, <span class="pl-v">type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>line<span class="pl-pds">'</span></span>, 
  <span class="pl-v">color</span> <span class="pl-k">=</span> <span class="pl-k">list</span>(<span class="pl-v">const</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>blue<span class="pl-pds">'</span></span>), <span class="pl-v">copy_layer</span> <span class="pl-k">=</span> <span class="pl-c1">T</span>, <span class="pl-v">tooltip</span> <span class="pl-k">=</span> <span class="pl-c1">NULL</span>)
<span class="pl-smi">p1</span><span class="pl-k">$</span>print(<span class="pl-s"><span class="pl-pds">'</span>chart2<span class="pl-pds">'</span></span>)</pre></div>

<p>Finally, we will overlay a line plot of <code>SOG</code> by <code>yearID</code> for a specific team <code>name</code>. Later, while building the shiny app, we will turn this into an input variable that a user can choose from a dropdown menu. We use the layer approach used earlier and this time override the <code>data</code> and <code>color</code> arguments so that the line plot for the team stands out from the league average.</p>

<div class="highlight highlight-r"><pre><span class="pl-v">myteam</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Boston Red Sox<span class="pl-pds">"</span></span>
<span class="pl-smi">p1</span><span class="pl-k">$</span>layer(<span class="pl-v">data</span> <span class="pl-k">=</span> <span class="pl-smi">team_data</span>[<span class="pl-smi">team_data</span><span class="pl-k">$</span><span class="pl-smi">name</span> <span class="pl-k">==</span> <span class="pl-smi">myteam</span>,], <span class="pl-v">color</span> <span class="pl-k">=</span> <span class="pl-k">list</span>(<span class="pl-v">const</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>red<span class="pl-pds">'</span></span>),
  <span class="pl-v">copy_layer</span> <span class="pl-k">=</span> <span class="pl-c1">T</span>)
<span class="pl-smi">p1</span><span class="pl-k">$</span>print(<span class="pl-s"><span class="pl-pds">'</span>chart3<span class="pl-pds">'</span></span>)</pre></div>

<p>Let us add a little more interactivity to the chart. To keep it simple, we will use handlers in PolychartJS to initiate an action when a user clicks on a point. Here is where the magic of <code>knitr</code> shines (thanks to <a href="http://github.com/yihui/knitr">yihui/knitr</a>), as we can mix coffeescript code in our document. The current handler is a simple one, which just displays the name of the team clicked on. If you are familiar with Coffeescript, the code is self explanatory.</p>

<div class="highlight highlight-r"><pre>graph_chart3.addHandler (<span class="pl-smi">type</span>, <span class="pl-smi">e</span>) <span class="pl-k">-</span><span class="pl-k">&gt;</span>
  <span class="pl-v">data</span> <span class="pl-k">=</span> <span class="pl-smi">e.evtData</span>
  <span class="pl-k">if</span> <span class="pl-smi">type</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>click<span class="pl-pds">'</span></span>
    <span class="pl-smi">alert</span> <span class="pl-s"><span class="pl-pds">"</span>You clicked on the team: <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-smi">data.name.in</span>[<span class="pl-c1">0</span>]</pre></div>



<h3>
<a id="application" class="anchor" href="#application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Application</h3>

<p>Now it is time to convert this into a Shiny App. We will throw the data processing code into <code>global.R</code> so that it can be accessed both by <code>ui.R</code> and <code>server.R</code>. For the dropdown menu allowing users to choose a specific team, we will restrict the choices to only those which have data for more than 30 years. Accordingly, we have the following <code>global.R</code>.</p>

<div class="highlight highlight-r"><pre><span class="pl-c">## global.R</span>
require(<span class="pl-smi">Lahman</span>)  
require(<span class="pl-smi">plyr</span>)
<span class="pl-v">dat</span> <span class="pl-k">=</span> <span class="pl-smi">Teams</span>[,c(<span class="pl-s"><span class="pl-pds">'</span>yearID<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>G<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>SO<span class="pl-pds">'</span></span>)]
<span class="pl-v">team_data</span> <span class="pl-k">=</span> na.omit(transform(<span class="pl-smi">dat</span>, <span class="pl-v">SOG</span> <span class="pl-k">=</span> round(<span class="pl-smi">SO</span><span class="pl-k">/</span><span class="pl-smi">G</span>, <span class="pl-c1">2</span>)))
<span class="pl-v">league_data</span> <span class="pl-k">=</span> ddply(<span class="pl-smi">team_data</span>, .(<span class="pl-smi">yearID</span>), <span class="pl-smi">summarize</span>, <span class="pl-v">SOG</span> <span class="pl-k">=</span> mean(<span class="pl-smi">SOG</span>))
<span class="pl-v">THRESHOLD</span> <span class="pl-k">=</span> <span class="pl-c1">30</span>
<span class="pl-v">team_appearances</span> <span class="pl-k">=</span> count(<span class="pl-smi">team_data</span>, .(<span class="pl-smi">name</span>))
<span class="pl-v">teams_in_menu</span> <span class="pl-k">=</span> subset(<span class="pl-smi">team_appearances</span>, <span class="pl-smi">freq</span> <span class="pl-k">&gt;</span> <span class="pl-smi">THRESHOLD</span>)<span class="pl-k">$</span><span class="pl-smi">name</span></pre></div>

<p>For the UI, we will use a bootstrap page with controls being displayed in the sidebar. Shiny makes it really easy to create a page like this. See the annotated graphic below and the <code>ui.R</code> code that accompanies it to understand how the different pieces fit together.</p>

<p><a href="http://glimmer.rstudio.com/ramnathv/strikeouts">
  <img src="http://www.clipular.com/c?5151018=o2zGtsIzD20s1dp25X1mLRSUTMk&amp;f=e04b448074961bf4efcb426b91886d8b">
</a></p>

<pre><code></code></pre>
<p>We now need to write the server part of the shiny app. Thankfully, this is the easiest part, since it just involves wrapping the charting code inside <code>renderChart</code> and replacing user inputs to enable reactivity. We add a few more lines of code to set the height and title and remove the axis titles, since they are self explanatory.</p>

<pre><code></code></pre>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/charlesberthillon">charlesberthillon</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>
